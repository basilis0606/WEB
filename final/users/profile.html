<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>haggle - Profile</title>
  <!-- Title icon -->
  <link rel="icon" href="/img/location-dot.svg" type="image/x-icon" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@100&family=Roboto&display=swap" rel="stylesheet">
  <!-- MDB -->
  <link rel="stylesheet" href="/css/mdb.min.css" />
</head>

<body style="background-color: #e2e5c5;">
  <!-- First Popper.js, then Bootstrap JS. In case Jquery is used It needs to be loaded first-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <section class="vh-100">
    <div class="container py-5 h-100">
      <div class="row d-flex justify-content-center align-items-center h-100">
        <div class="col col-xl-9 col-lg-10 col-md-11" style="width: 100%;">
          <div class="card" style="border-radius: 1rem;">
            <div class="row g-0">
              <h4 class="text-dark m-4">Profile Settings</h4>
              <div class="row mb-3">
                <div class="col-lg-4">
                  <div class="card shadow mb-4">
                    <div class="card-header py-3">
                      <h6 class="text-primary fw-bold m-0">User's Progress</h6>
                    </div>
                    <div class="card-body">
                      <h4 class="small fw-bold">Last Months Tokens:<span id="monthlyTokens" class="float-end"></span>
                      </h4>
                      <h4 class="small fw-bold">Total Tokens:<span id="totalTokens" class="float-end"></span></h4>
                      <h4 class="small fw-bold">Monthly Score:<span id="monthlyScore" class="float-end"></span></h4>
                      <h4 class="small fw-bold">Total Score<span id="totalScore" class="float-end"></span></h4>
                    </div>
                  </div>
                </div>
                <div class="col-lg-8">
                  <div class="row">
                    <div class="col">
                      <div class="card shadow mb-3">
                        <div class="card-header py-3">
                          <p class="text-primary m-0 fw-bold">User Settings</p>
                        </div>
                        <div class="card-body">
                          <form id="updateCredentialsForm" onsubmit="event.preventDefault(); updateCredentials();">
                            <div class="row">
                              <div class="col">
                                <div class="mb-3">
                                  <label class="form-label" for="username"><strong><i class="fas fa-user"></i>
                                      Username</strong></label>
                                  <input class="custom-focus form-control" type="text" id="username" name="username">
                                </div>
                              </div>
                              <div class="col">
                                <div class="mb-3">
                                  <label class="form-label" for="email">
                                    <strong><i class="fas fa-envelope"></i> Email Address</strong>
                                  </label>
                                  <input class="form-control" type="email" id="email" name="email" disabled>
                                </div>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col">
                                <div class="mb-3"><label class="form-label" for="first_name"><strong>Password
                                    </strong></label><input class="form-control" type="password" id="password"
                                    placeholder="Current Password" name="password"></div>
                              </div>
                              <div class="col">
                                <div class="mb-3"><label class="form-label" for="last_name"><strong>New password
                                    </strong></label><span> </span><input class="form-control" type="password"
                                    id="newPassword" placeholder="Optionally change password" name="new password"></div>
                              </div>
                            </div>
                            <div class="mb-3"><button id="submitUserButton" class="btn btn-primary btn-sm"
                                onclick="updateCredentials()" type="button">Save
                                Settings</button></div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row g-0">
              <div class="col mx-4 text-nowrap">
                <div class="card shadow mb-4">
                  <div class="card-header py-3">
                    <h6 class="text-primary fw-bold m-0">Like Activity</h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive table mt-2" id="dataTable" role="grid"
                      aria-describedby="dataTable_info">
                      <table class="table my-0" id="likesTable">
                        <thead>
                          <tr>
                            <th>Offer</th>
                            <th>Location / Store</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Table rows for like activity -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col mx-4 text-nowrap">
                <div class="card shadow mb-4">
                  <div class="card-header py-3">
                    <h6 class="text-primary fw-bold m-0">Dislike Activity</h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive table mt-2" id="dataTable" role="grid"
                      aria-describedby="dataTable_info">
                      <table class="table my-0" id="dislikesTable">
                        <thead>
                          <tr>
                            <th>Offer</th>
                            <th>Location / Store</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Table rows for dislike activity -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row g-0">
              <!-- Users posted Offers -->
              <div class="col mx-4 text-nowrap">
                <div class="card shadow mb-4">
                  <div class="card-header py-3">
                    <h6 class="text-primary fw-bold m-0">Posted Offers</h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive table mt-2" id="dataTable" role="grid"
                      aria-describedby="dataTable_info">
                      <table class="table my-0" id="postedOffersTable">
                        <thead>
                          <tr>
                            <th>Offer</th>
                            <th>Location / Store</th>
                            <th>Price</th>
                            <th>Posted</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Table rows for posted offers -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MDB -->
  <script type="text/javascript" src="/js/mdb.min.js"></script>

  <!-- Custom scripts -->
  <script type="text/javascript">
    //------------------ FETCH API ----------------------//
    async function fetchAPI(url, method, data = {}) {
      const requestOptions = {
        method: method,
        credentials: 'include',
        redirect: 'follow',
        headers: {
          "Content-Type": "application/json",
        },
      };
      if (method !== "GET") {
        requestOptions.body = JSON.stringify(data);
      }
      return await fetch(url, requestOptions)
        .then(async (response) => {
          if (response.status === 401) {
            // Check if the response includes an "unauthorized" message
            const errorData = await response.json();
            if (errorData.message === 'unauthorized') {

              console.error('Unauthorized access.');
              alert('Session expired. Please login again.');
              // Redirect to the login page
              window.location.href = '/login.html';
              return Promise.reject('Unauthorized access');
            }
          }

          if (!response.ok) {
            // Handle other errors
            console.error(`Error: ${response.status}`);
            throw new Error('Something went wrong. Please try again later.');
          }

          return response.json();
        })
        .catch(error => {
          console.error(error);
          throw new Error('Something went wrong. Please try again later.');
        });
    }
    //------------------ FETCH INFO ----------------------//

    function fetchUserInfo() {
      fetchAPI('/users/info', 'GET')
        .then(userInfo => {
          const usernameInput = document.getElementById('username');
          const emailInput = document.getElementById('email');
          document.getElementById('monthlyTokens').textContent = userInfo.userInfo.monthly_tokens;
          document.getElementById('totalTokens').textContent = userInfo.userInfo.sum_tokens;
          document.getElementById('monthlyScore').textContent = userInfo.userInfo.monthly_score;
          document.getElementById('totalScore').textContent = userInfo.userInfo.sum_score;
          usernameInput.value = userInfo.userInfo.username;
          emailInput.value = userInfo.userInfo.email;

        })
        .catch(error => {
          console.error(error);
        });
    }
    fetchUserInfo();

    //------------------ UPDATE CREDENTIALS ----------------------//

    function updateCredentials() {
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const newPasswordInput = document.getElementById('newPassword');

      const username = usernameInput.value;
      const password = passwordInput.value;
      const newPassword = newPasswordInput.value;

      const data = {
        username: username,
        password: password,
        newPassword: newPassword
      };

      fetchAPI('/users/update-credentials', 'POST', data)
        .then(response => {

          if (response.success) {
            alert(response.message);
            window.location.href = "/users/profile";
          } else {
            alert(response.message);
          }
        })
        .catch(error => {
          console.error(error);
        });
    }
    window.onload = function () {
      document.getElementById('password').value = '';
      document.getElementById('newPassword').value = '';
    };

    //------------------ FETCH LIKE ACTIVITY ----------------------//

    function fetchLikes() {
      fetchAPI('/users/likes', 'GET')
        .then(response => {
          const likes = response.userLikes;

          const likesTableBody = document.getElementById('likesTable').getElementsByTagName('tbody')[0];

          likesTableBody.innerHTML = '';

          likes.forEach(like => {
            const likeTableRow = document.createElement('tr');
            const likeTableRowOffer = document.createElement('td');
            const likeTableRowLocation = document.createElement('td');

            likeTableRowOffer.textContent = like.product_name;
            likeTableRowLocation.textContent = like.store_name;

            likeTableRow.appendChild(likeTableRowOffer);
            likeTableRow.appendChild(likeTableRowLocation);
            likesTableBody.appendChild(likeTableRow);
          });
        })
        .catch(error => {
          console.error(error);
        });
    }
    fetchLikes();

    //------------------ FETCH DISLIKE ACTIVITY ----------------------//
    function fetchDislikes() {
      fetchAPI('/users/dislikes', 'GET')
        .then(dislikes => {
          const dislikesArray = dislikes.userDislikes;

          const dislikesTableBody = document.getElementById('dislikesTable').getElementsByTagName('tbody')[0];

          // Clear existing rows
          dislikesTableBody.innerHTML = '';

          dislikesArray.forEach(dislike => {
            const dislikeTableRow = document.createElement('tr');
            const dislikeTableRowOffer = document.createElement('td');
            const dislikeTableRowLocation = document.createElement('td');

            dislikeTableRowOffer.textContent = dislike.product_name;
            dislikeTableRowLocation.textContent = dislike.store_name;

            dislikeTableRow.appendChild(dislikeTableRowOffer);
            dislikeTableRow.appendChild(dislikeTableRowLocation);
            dislikesTableBody.appendChild(dislikeTableRow);
          });
        })
        .catch(error => {
          console.error(error);
        });
    }
    fetchDislikes();

    //------------------ FETCH POSTED OFFERS ----------------------//
    function fetchSubmittedOffers() {
      fetchAPI('/users/submitted-offers', 'GET')
        .then(response => {
          const offersArray = response.userOffers;

          const offersTableBody = document.getElementById('postedOffersTable').getElementsByTagName('tbody')[0];

          // Clear existing rows
          offersTableBody.innerHTML = '';

          offersArray.forEach(offer => {
            const offerTableRow = document.createElement('tr');
            const offerTableRowOffer = document.createElement('td');
            const offerTableRowLocation = document.createElement('td');
            const offerTableRowPrice = document.createElement('td');
            const offerTableRowPosted = document.createElement('td');

            offerTableRowOffer.textContent = offer.product_name;
            offerTableRowLocation.textContent = offer.store_name;
            offerTableRowPrice.textContent = offer.price;
            offerTableRowPosted.textContent = new Date(offer.date_created).toLocaleDateString();  // format the date to a more user-friendly string

            offerTableRow.appendChild(offerTableRowOffer);
            offerTableRow.appendChild(offerTableRowLocation);
            offerTableRow.appendChild(offerTableRowPrice);
            offerTableRow.appendChild(offerTableRowPosted);
            offersTableBody.appendChild(offerTableRow);
          });
        })
        .catch(error => {
          console.error(error);
        });
    }
    fetchSubmittedOffers();


  </script>

</body>

</html>