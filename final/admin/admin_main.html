<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
    <title>haggle: Admin</title>
    <link rel="stylesheet" href="/adm_assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/adm_assets/css/pagination.css">
    <link rel="stylesheet" href="/adm_assets/css/Acme.css">
    <link rel="stylesheet" href="/adm_assets/css/Actor.css">
    <link rel="stylesheet" href="/adm_assets/css/Akaya%20Telivigala.css">
    <link rel="stylesheet" href="/adm_assets/css/Akshar.css">
    <link rel="stylesheet" href="/adm_assets/css/Alata.css">
    <link rel="stylesheet" href="/adm_assets/css/Alatsi.css">
    <link rel="stylesheet" href="/adm_assets/css/Navbar-With-Button-icons.css">
</head>

<body style="background: url(&quot;/adm_assets/img/white%20background.jpg&quot;); background-size:cover;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <img style="width:56px; height:56px;" src="/adm_assets/img/8033099971580816655-128.png">
            <a href="#" class="navbar-brand" style="margin-left: 0.5%;">Welcome Admin!</a>
            <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto">
                    <a href="/users/profile.html" class="nav-item nav-link">Profile Settings</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <div>
            <ul class="nav nav-tabs" role="tablist" style="margin-left: 1%; margin-right: 1%;">
                <li class="nav-item" role="presentation" id="products_tab" style="width:14%" ;><a
                        class="nav-link active" role="tab" data-bs-toggle="tab" href="#tab-1"
                        style="border-top-left-radius: 4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;border-bottom-left-radius: 4px;margin: 0px;background: url(&quot;/adm_assets/img/14957230881678785316-128.png&quot;) center / contain no-repeat, transparent;height: 60px;"></a>
                </li>
                <li class="nav-item" role="presentation" id="categories_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-2"
                        style="height: 60px;background: url(&quot;/adm_assets/img/categories.png&quot;) center / contain no-repeat;"></a>
                </li>
                <li class="nav-item" role="presentation" id="stores_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-3"
                        style="height: 60px;background: url(&quot;/adm_assets/img/8015517251578289043-128.png&quot;) center / contain no-repeat;"></a>
                </li>
                <li class="nav-item" role="presentation" id="stats_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-4"
                        style="height: 60px;background: url(&quot;/adm_assets/img/544378381639220039-128.png&quot;) center / contain no-repeat;"></a>
                </li>
                <li class="nav-item" role="presentation" id="leaders_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-5"
                        style="height: 60px;background: url(&quot;/adm_assets/img/leaderboard2.png&quot;) center / contain no-repeat;"></a>
                </li>
                <li class="nav-item" role="presentation" id="chmode_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-6"
                        style="height: 60px;margin: 0px;background: url(&quot;/adm_assets/img/781752361582955604-128.png&quot;) center / contain no-repeat;"></a>
                </li>
                <li class="nav-item" role="presentation" id="logout_tab" style="width:14%" ;><a class="nav-link"
                        role="tab" data-bs-toggle="tab" href="#tab-7"
                        style="height: 60px;background: url(&quot;/adm_assets/img/logout2.png&quot;) center / contain no-repeat;"></a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" role="tabpanel" id="tab-1">
                    <div class="table-responsive" id="products_table" style="opacity: 1; max-height: 700px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="position: relative;text-align: center;"></th>
                                    <th style="position: relative;text-align: center;">ID</th>
                                    <th style="position: relative;text-align: center;">NAME</th>
                                    <th style="width: 20%; position: relative;text-align: center;">AVG PRICE YESTERDAY
                                    </th>
                                    <th style="position: relative;text-align: center;">SUBCATEGORY</th>
                                    <th style="position: relative;text-align: center;">CATEGORY</th>
                                </tr>
                            </thead>
                            <tbody id="products_tbody"></tbody>
                        </table>
                    </div>
                    <div class="row" style="margin-top: 5%; margin-bottom: 1%;">
                        <div class="col">
                            <button id="delprods_button" class="btn btn-primary" type="button">DELETE</button>
                        </div>
                        <div class="col">
                            <form action="/admin/uploadprods" method="POST" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col">
                                        <input class="form-control" type="file" name="file" style="width: auto;">
                                    </div>
                                    <div class="col">
                                        <input class="btn btn-primary" type="submit" value="Upload File">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" role="tabpanel" id="tab-2" style="opacity: 1;">
                    <div class="table-responsive" id="categories_table" style="opacity: 1; max-height: 700px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="position: relative; text-align: center;"></th>
                                    <th style="position: relative; text-align: center;">ID</th>
                                    <th style="position: relative; text-align: center;">NAME</th>
                                    <th style="position: relative; text-align: center;">CATEGORY ID</th>
                                    <th style="position: relative; text-align: center;">CATEGORY NAME</th>
                                </tr>
                            </thead>
                            <tbody id="categories_tbody"></tbody>
                        </table>
                    </div>
                    <div class="row" style="margin-top: 5%; margin-bottom: 1%;">
                        <div class="col">
                            <button id="delcats_button" class="btn btn-primary" type="button">DELETE</button>
                        </div>
                        <div class="col">
                            <form action="/admin/uploadcats" method="POST" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col">
                                        <input class="form-control" type="file" name="file" style="width: auto;">
                                    </div>
                                    <div class="col">
                                        <input class="btn btn-primary" type="submit" value="Upload File">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" role="tabpanel" id="tab-3">
                    <div class="table-responsive" id="stores_table" style="opacity: 1;max-height: 700px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="position: relative; text-align: center;"></th>
                                    <th style="position: relative; text-align: center;">ID</th>
                                    <th style="position: relative; text-align: center;">LATITUDE</th>
                                    <th style="position: relative; text-align: center;">LONGITUDE</th>
                                    <th style="position: relative; text-align: center;">NAME</th>
                                </tr>
                            </thead>
                            <tbody id="stores_tbody"></tbody>
                        </table>
                    </div>
                    <div class="row" style="margin-top: 5%; margin-bottom: 1%;">
                        <div class="col">
                            <button id="delstores_button" class="btn btn-primary" type="button">DELETE</button>
                        </div>
                        <div class="col">
                            <form action="/admin/uploadstores" method="POST" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col">
                                        <input class="form-control" type="file" name="file" style="width: auto;">
                                    </div>
                                    <div class="col">
                                        <input class="btn btn-primary" type="submit" value="Upload File">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" role="tabpanel" id="tab-4">
                    <div class="container">
                        <div class="row" style="margin-top: 2%;">
                            <div class="col">
                                <div class="dropdown">
                                    <button id="monthDropdown_button" class="btn btn-primary dropdown-toggle"
                                        aria-expanded="false" data-bs-toggle="dropdown" type="button"
                                        style="margin-top: 0px;">Month</button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('January', 'month')">January</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('February', 'month')">February</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('March', 'month')">March</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('April', 'month')">April</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('May', 'month')">May</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('June', 'month')">June</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('July', 'month')">July</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('August', 'month')">August</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('September', 'month')">September</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('October', 'month')">October</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('November', 'month')">November</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('December', 'month')">December</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="dropdown">
                                    <button id="yearDropdown_button" class="btn btn-primary dropdown-toggle"
                                        aria-expanded="false" data-bs-toggle="dropdown" type="button"
                                        style="margin-left: 0px;">Year</button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText(2020, 'year')">2020</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText(2021, 'year')">2021</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText(2022, 'year')">2022</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText(2023, 'year')">2023</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <button id="refreshChart1_button" class="btn btn-primary" type="button"
                                    style="width: 24px;height: 24px; margin-top: 5%; background: url(&quot;/adm_assets/img/293271_replay_restart_refresh_icon.png&quot;) center / contain;">
                            </div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                        </div>
                        <div class="row" style="margin-top: 1%;">
                            <p>
                                Please select month and year to construct the sales graph.
                            </p>
                        </div>
                        <div id="saleschartContainer">

                        </div>
                    </div>
                    <div class="container" style="position: relative; margin-top:450px">
                        <div class="row">
                            <div class="col">
                                <div class="dropdown">
                                    <button id="categoryDropdown_button" class="btn btn-primary dropdown-toggle"
                                        aria-expanded="false" data-bs-toggle="dropdown" type="button"
                                        style="margin-top: 0px;">Category</button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Βρεφικά Είδη', 'category'); bringSubcategories('Βρεφικά Είδη')">Βρεφικά
                                            Είδη</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Καθαριότητα', 'category'); bringSubcategories('Καθαριότητα')">Καθαριότητα</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Ποτά - Αναψυκτικά', 'category'); bringSubcategories('Ποτά - Αναψυκτικά')">Ποτά
                                            - Αναψυκτικά</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Προσωπική φροντίδα', 'category'); bringSubcategories('Προσωπική φροντίδα')">Προσωπική
                                            Φροντίδα</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Τρόφιμα', 'category'); bringSubcategories('Τρόφιμα')">Τρόφιμα</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Αντισηπτικά', 'category'); bringSubcategories('Αντισηπτικά')">Αντισηπτικά</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Προστασία Υγείας', 'category'); bringSubcategories('Προστασία Υγείας')">Προστασία
                                            Υγείας</a>
                                        <a class="dropdown-item" href="#"
                                            onclick="changeDropdownButtonText('Για κατοικίδια', 'category'); bringSubcategories('Για κατοικίδια')">Για
                                            κατοικίδια</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="dropdown">
                                    <button id="subcategoryDropdown_button" class="btn btn-primary dropdown-toggle"
                                        aria-expanded="false" data-bs-toggle="dropdown"
                                        type="button">Subcategory</button>
                                    <div class="dropdown-menu" , id="subcategories_menu"
                                        style="max-height: 250px; overflow-y: scroll;">
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <button id="refreshChart2_button" class="btn btn-primary" type="button"
                                    style="width: 24px;height: 24px;  margin-top: 5%; background: url(&quot;/adm_assets/img/293271_replay_restart_refresh_icon.png&quot;) center / contain;"></button>
                            </div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                            <div class="col"></div>
                        </div>
                        <div class="row" style="margin-top: 1%;">
                            <p>
                                Please select category (and subcategory) for the average discount graph.
                            </p>
                        </div>
                        <div id="discountchartContainer">

                        </div>
                    </div>

                </div>
                <div class="tab-pane" role="tabpanel" id="tab-5">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th> </th>
                                    <th>USERNAME</th>
                                    <th style="position: relative; text-align: center;">TOTAL SCORE</th>
                                    <th style="position: relative; text-align: center;">TOKENS LAST MONTH</th>
                                    <th style="position: relative; text-align: center;">TOTAL TOKENS</th>
                                </tr>
                            </thead>
                            <tbody id="users_tbody">

                            </tbody>
                        </table>
                    </div>
                    <nav class="pagination-container">
                        <button class="pagination-button" id="prev-button" title="Previous page"
                            aria-label="Previous page">
                            &lt;
                        </button>

                        <div id="pagination-numbers">
                        </div>

                        <button class="pagination-button" id="next-button" title="Next page" aria-label="Next page">
                            &gt;
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <script src="/adm_assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>

    <!-- Custom scripts -->
    <script type="text/javascript">
        //variable initialization
        let fetched_products = false;
        let fetched_stores = false;
        let fetched_categories = false;
        let fetched_stats = false;
        let fetched_leaderboard = false;

        //interactive DOM elements 
        //TABS
        let productstab = document.getElementById("products_tab");
        let categoriestab = document.getElementById("categories_tab");
        let storestab = document.getElementById("stores_tab");
        let statstab = document.getElementById("stats_tab");
        let leaderstab = document.getElementById("leaders_tab");
        let modetab = document.getElementById("chmode_tab");
        let logouttab = document.getElementById("logout_tab");

        //BUTTONS
        let profsettings_btn = document.getElementById("profilesettings_button");

        let deleteproducts_btn = document.getElementById("delprods_button");
        let deletecategories_btn = document.getElementById("delcats_button");
        let deletestores_btn = document.getElementById("delstores_button");

        let refreshchart1_btn = document.getElementById("refreshChart1_button");
        let refreshchart2_btn = document.getElementById("refreshChart2_button");
        let monthdropdown_btn = document.getElementById("monthDropdown_button");
        let yeardropdown_btn = document.getElementById("yearDropDown_button");
        let categorydropdown_btn = document.getElementById("categoryDropdown_button");
        let subcategorydropdown_btn = document.getElementById("subcategoryDropdown_button");

        //VARIABLES
        let pagesNum = 0;

        //------------------ FETCH API ----------------------//
        async function fetchAPI(url, method, data = {}) {
            const requestOptions = {
                method: method,
                credentials: 'include',
                redirect: 'follow',
                headers: {
                    "Content-Type": "application/json",
                },
            };
            if (method !== "GET") {
                requestOptions.body = JSON.stringify(data);
            }
            return await fetch(url, requestOptions)
                .then(async (response) => {
                    if (response.status === 401) {

                        console.error('Unauthorized access.');
                        alert('Session expired. Please login again.');
                        // Redirect to the login page
                        window.location.href = '/login.html';
                        return Promise.reject('Unauthorized access');
                    }

                    if (!response.ok) {
                        // Handle other errors
                        console.error(`Error: ${response.status}`);
                        throw new Error('Something went wrong. Please try again later.');
                    }

                    return response.json();
                })
                .catch(error => {
                    console.error(error);
                    throw new Error('Something went wrong. Please try again later.');
                });
        }

        //---------- Populate Tables Functions ---------------//
        function populateProductsTable() {
            //table to be populated
            const prodtable = document.getElementById("products_tbody");
            prodtable.innerHTML = "";
            //bring db data
            let products = fetchAPI('/admin/products', "GET");
            products.then((res) => {
                //check if response was returned correctly
                if ((res) !== 'undefined') {
                    //DYNAMIC TABLE CONSTRUCTION: for each item in the products table of the res json object, 
                    //create a row with the correct fields
                    //(if your table body contains junk data, you can clear it with tablebody.innerHTML = '';)
                    res.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td style="position: relative;"><input type="checkbox" name="productCheckbox"></td>
                        <td style="position: relative; text-align: center;">${item.id}\t\t\t</td>
                        <td style="width:40%; position: relative;">${item.pnm}</td>
                        <td style="width:20%; position: relative; text-align: center;">${item.avgprice_yesterday}</td>
                        <td style="position: relative; text-align: center;">${item.snm}</td>
                        <td style="position: relative; text-align: center;">${item.cnm}</td>
                    `;
                        prodtable.appendChild(row);
                    });
                    fetched_products = true;
                }
            }).catch(error => {
                console.error(error);
            });
        }

        function populateCategoriesTable() {
            const cattable = document.getElementById("categories_tbody");
            cattable.innerHTML = '';
            //bring db data
            let categories = fetchAPI('/admin/subcategories', "GET");
            categories.then((res) => {
                if (res !== 'undefined') {
                    res.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><input type="checkbox" name="subcategoryCheckbox" style="text-align: center;"></td>
                        <td style="text-align: center;">${item.id}</td>
                        <td style="text-align: center;">${item.subname}</td>
                        <td style="text-align: center;">${item.categories_id}</td>
                        <td style="text-align: center;">${item.name}</td>
                        
                    `;
                        cattable.appendChild(row);

                    });
                    fetched_categories = true;
                }
            })
        }

        function populateStoresTable() {
            const storestable = document.getElementById("stores_tbody");
            storestable.innerHTML = '';

            //get post or what??
            let stores = fetchAPI('/admin/stores', "GET");
            stores.then((res) => {
                //code for table construction here
                if ((res) !== 'undefined') {
                    //DYNAMIC TABLE CONSTRUCTION
                    res.forEach(item => {
                        const row = document.createElement('tr');
                        if (item.name == null) item.name = "unknown";
                        row.innerHTML = `
                        <td><input type="checkbox" name="storeCheckbox" style="text-align: center;"></td>
                        <td style="text-align: center;">${item.id}</td>
                        <td style="text-align: center;">${item.lat}</td>
                        <td style="text-align: center;">${item.lon}</td>
                        <td style="text-align: center;">${item.name}</td>
                    `;
                        storestable.appendChild(row);
                    });

                    fetched_stores = true;
                }
            }).catch(error => {
                console.error(error);
            });

        }

        //---------------- Delete From Table ---------------//
        function deleteProducts() {
            const selectedRows = document.querySelectorAll("input[name='productCheckbox']:checked");
            const selectedIds = Array.from(selectedRows).map(row => parseInt(row.parentElement.nextElementSibling.textContent));
            console.log("Ids to delete: ", selectedIds);
            // Send a request to the Express.js server to delete the selected products
            let todel = fetchAPI('/admin/delprods', "POST", selectedIds);
            //promise pending??
            todel.then((result) => {
                if (result.success) {
                    selectedRows.forEach(row => {
                        let rowToDelete = row.closest("tr");
                        rowToDelete.remove();
                    })
                }
            })
        }

        function deleteCategories() {
            const selectedRows = document.querySelectorAll("input[name='subcategoryCheckbox']:checked");
            const selectedIds = Array.from(selectedRows).map(row => parseInt(row.parentElement.nextElementSibling.textContent));

            // Send a request to the Express.js server to delete the selected products
            let todel = fetchAPI('/admin/delcats', "POST", selectedIds);
            todel.then((result) => {
                if (result.success) {
                    selectedRows.forEach(row => {
                        let rowToDelete = row.closest("tr");
                        rowToDelete.remove();
                    })
                } else {
                    console.error("Failed to delete products");
                }
            });
        }

        function deleteStores() {
            const selectedRows = document.querySelectorAll("input[name='storeCheckbox']:checked");
            const selectedIds = Array.from(selectedRows).map(row => parseInt(row.parentElement.nextElementSibling.textContent));

            // Send a request to the Express.js server to delete the selected products
            let todel = fetchAPI('/admin/delstores', "POST", selectedIds);
            todel.then((result) => {
                if (result.success) {
                    selectedRows.forEach(row => {
                        let rowToDelete = row.closest("tr");
                        rowToDelete.remove();
                    })
                } else {
                    console.error("Failed to delete products");
                }
            });
        }

        //-------------- Graph Functions -----------------//
        function salesGraph(month, year) {
            document.getElementById("saleschartContainer").innerHTML = '';
            month_num = getMonthNumberFromName(month);
            //console.log("month num: ", month_num, " year: ", year)
            let stats = fetchAPI('/admin/stats/sales', "POST", [month_num, year]);
            //construct x-axis data according to the month
            //number of days in evens months: normally 30 
            let days = 30;
            if (month_num == 2 && (year % 4 == 0)) days = 29;       //February of leap year
            else if (month_num == 2) days = 28;                     //February of non-leap year
            else if (month_num == 8 || month_num == 12) days = 31;  //the only even months with 31 days
            else days = 31;                                         //odd month

            //make sure, date labels match SQL returned dates
            if (month_num < 10) month_num = `0${month_num}`;
            let data = [];
            for (i = 1; i <= days; i++) {
                if (i < 10) data.push({ y: 0, label: `${year}-${month_num}-0${i}` });
                else data.push({ y: 0, label: `${year}-${month_num}-${i}` });
            }

            stats.then((res) => {
                // console.log("DB data: ", res);
                /*
                res.forEach(datapoint => {
                    //make sure sql returned date matches the constructed ones
                    datapoint.date_created = datapoint.date_created.substring(0,10);
                    console.log(datapoint.date_created," ", typeof datapoint.date_created);
                    console.log(data[30].y, " ", typeof data[30].y, data[30].label, " ", typeof data[30].label);
                    if (data[datapoint.date_created]) data[datapoint.date_created].y = datapoint.totsales;    //data has all dates, so there is no reference problem                
                });*/


                //the simple non-efficient solution
                res.forEach(datapoint => {
                    //make sure sql returned date matches the constructed ones
                    datapoint.date_created = datapoint.date_created.substring(0, 10);
                    data.forEach(item => {
                        if (item.label == datapoint.date_created) item.y = parseInt(datapoint.totsales);
                    })
                });
                //console.log("Final data: ", data);
                //chart code
                var chart = new CanvasJS.Chart("saleschartContainer",
                    {
                        animationEnabled: true,
                        title: {
                            text: `Number of sales in ${month} of ${year}`
                        },
                        dataPointWidth: 20,
                        data: [
                            {
                                type: "column",
                                dataPoints: data
                            }
                        ]
                    });
                chart.render();
            })

        }

        function discountGraph(cat, subcat) {
            document.getElementById("discountchartContainer").innerHTML = '';
            let avgdiscount = fetchAPI('/admin/stats/avgdiscount', "POST", [cat, subcat]);

            avgdiscount.then((res) => {
                let data = [];
                res.forEach(productAVGdiscount => {
                    data.push({ y: productAVGdiscount.avg_discount, label: productAVGdiscount.pnm });
                })
                //chart code

                var chart = new CanvasJS.Chart("discountchartContainer",
                    {
                        animationEnabled: true,
                        title: {
                            text: `Average Discount per Product in ${cat}:${subcat}`
                        },
                        dataPointWidth: 20,
                        data: [
                            {
                                type: "column",
                                dataPoints: data
                            }
                        ]
                    });
                chart.render();

            })
        }

        //------------ Leaderboard Functions ---------------//
        function displayleaderboard() {
            //bring all users
            let leadusers = fetchAPI('/admin/leaderboard', "GET");
            leadusers.then((result) => {
                //CONSTRUCT PAGINATION DYNAMICALLY
                pagesNum = Math.ceil(result.length / 10);
                let pagesnumbuttons = document.getElementById("pagination-numbers");
                for (let i = 1; i <= pagesNum; i++) {
                    const pageNumber = document.createElement("button");
                    pageNumber.className = "pagination-number";
                    pageNumber.innerHTML = i;
                    pageNumber.setAttribute("page-index", i);
                    pageNumber.setAttribute("aria-label", "Page " + i);

                    pagesnumbuttons.appendChild(pageNumber);
                }

                //add Event Listeners on all pagination number buttons
                document.querySelectorAll(".pagination-number").forEach((button) => {
                    const pageIndex = Number(button.getAttribute("page-index"));
                    if (pageIndex) {
                        button.addEventListener("click", () => {
                            setCurrentPage(pageIndex);
                        });
                    }
                });
                //add Event Listeners on previous and next buttons
                document.getElementById("prev-button").addEventListener("click", () => {
                    setCurrentPage(currentPage - 1);
                });
                document.getElementById("next-button").addEventListener("click", () => {
                    setCurrentPage(currentPage + 1);
                });

                //fill up the table
                let userstable = document.getElementById("users_tbody");
                userstable.innerHTML = '';
                let i = 1;
                result.forEach(userdata => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td style="width: 180px; position: relative;">${i}</td>
                    <td style="width: 70px; position: relative;">${userdata.username}\t\t\t</td>
                    <td style="width:400px; position: relative; text-align: center;">${userdata.sum_score}</td>
                    <td style="width:200px;position: relative; text-align: center;">${userdata.monthly_tokens}</td>
                    <td style="width: 180px; position: relative; text-align: center;">${userdata.sum_tokens}</td>`;
                    userstable.appendChild(row);
                    i++;
                });
                fetched_leaderboard = true;
                //hide everything but page 1
                setCurrentPage(1);
            });
            fetched_leaderboard = true;

        }

        const setCurrentPage = (pageNum) => {
            currentPage = pageNum;
            handleActivePageNumber();
            handlePageButtonsStatus();

            // hide/show table rows
            const prevRange = (pageNum - 1) * 10;
            const currRange = pageNum * 10;

            let usersTRows = Array.from(document.getElementById("users_tbody").children);
            usersTRows.forEach((item, index) => {
                item.classList.add("hidden");
                if (index >= prevRange && index < currRange) {
                    item.classList.remove("hidden");
                }
            });
        };

        //declare page as active
        const handleActivePageNumber = () => {
            document.querySelectorAll(".pagination-number").forEach((button) => {
                button.classList.remove("active");
                const pageIndex = Number(button.getAttribute("page-index"));
                if (pageIndex == currentPage) {
                    button.classList.add("active");
                }
            });
        };

        //3 functions to enable/disable next and previous buttons
        const disableButton = (button) => {
            button.classList.add("disabled");
            button.setAttribute("disabled", true);
        };

        const enableButton = (button) => {
            button.classList.remove("disabled");
            button.removeAttribute("disabled");
        };

        const handlePageButtonsStatus = (number) => {
            let prevButton = document.getElementById("prev-button");
            let nextButton = document.getElementById("next-button");
            //1st page
            if (currentPage === 1) {
                disableButton(prevButton);
            } else {
                enableButton(prevButton);
            }//last page
            if (pagesNum === currentPage) {
                disableButton(nextButton);
            } else {
                enableButton(nextButton);
            }
        };

        //------------- Event Listeners -------------------//
        function initializeTabEventListeners() {
            //every time the page is loaded, we bring products and categories. 
            //the tab listeners for the products and categories tabs might seem unecessary, 
            //but what if the admin was in another tab when he left the page and then returned? can i force a tab to be selected when i initialize the page?
            productstab.addEventListener('click', () => {
                if (fetched_products == false) {
                    populateProductsTable();
                }
            });

            categoriestab.addEventListener('click', () => {
                if (fetched_categories == false) {
                    populateCategoriesTable();
                }
            });

            storestab.addEventListener('click', () => {
                if (fetched_stores == false) {
                    populateStoresTable();
                }
            });

            leaderstab.addEventListener('click', () => {
                if (fetched_leaderboard == false)
                    displayleaderboard();
            });

            modetab.addEventListener('click', () => {
                window.location.href = '/admin/admin_map.html';
            })

            logouttab.addEventListener('click', () => {
                logout();
            })
        }

        function initializeButtonEventListeners() {
            deleteproducts_btn.addEventListener('click', () => {
                deleteProducts();
            });

            deletecategories_btn.addEventListener('click', () => {
                deleteCategories();
            });

            deletestores_btn.addEventListener('click', () => {
                deleteStores();
            });

            refreshchart1_btn.addEventListener('click', () => {
                let month = getDropdownButtonText('month');
                let year = getDropdownButtonText('year');
                if (month !== 'Month' && year !== 'Year') {
                    salesGraph(month, year);
                }
            });

            refreshchart2_btn.addEventListener('click', () => {
                let category = getDropdownButtonText('category');
                let subcategory = getDropdownButtonText('subcategory');
                if (category !== 'Category')
                    discountGraph(category, subcategory);
            });

        }

        //===============Helping Functions=================//
        function changeDropdownButtonText(value, option) {
            if (option == 'month') {
                monthDropdown_button.textContent = value;
            } else if (option == 'year') {
                yearDropdown_button.textContent = value;
            }
            else if (option == 'category') {
                categorydropdown_btn.textContent = value;
            }
            else {
                subcategorydropdown_btn.textContent = value;
            }
        }

        function getDropdownButtonText(option) {
            let value = "";
            if (option == 'month') {
                value = monthDropdown_button.textContent;
            }
            else if (option == 'year') {
                value = yearDropdown_button.textContent;
            }
            else if (option == 'category') {
                value = categoryDropdown_button.textContent;
            }
            else {
                value = subcategoryDropdown_button.textContent;
            }
            return value;
        }

        function getMonthNumberFromName(monthName) {
            return new Date(`${monthName} 1, 2022`).getMonth() + 1;
        }

        function bringSubcategories(catname) {
            let subcats = fetchAPI('/admin/subcats', "POST", [catname]);
            sbcmenu = document.getElementById("subcategories_menu");
            sbcmenu.innerHTML = '';
            let firstitem = document.createElement('a');
            firstitem.innerHTML = `<a class="dropdown-item" href="#" onclick="changeDropdownButtonText('All')", 'subcategory')">All</a>`
            sbcmenu.appendChild(firstitem);
            subcats.then((names) => {
                names.forEach(sbc_nm => {
                    const menuitem = document.createElement('a');
                    menuitem.innerHTML = `<a class="dropdown-item" href="#" onclick="changeDropdownButtonText('${sbc_nm.name}', 'subcategory')">${sbc_nm.name}</a>`
                    sbcmenu.appendChild(menuitem);
                })
            })

        }

        //-------------------- Logout ---------------------//
        function logout() {
            // Make a GET request to the logout route on the server
            fetch('/users/logout', {
                method: 'POST',
                credentials: 'include', // Include credentials (cookies) in the request
                redirect: 'follow'
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Logout successful');
                        window.location.href = '/login.html';
                    } else {
                        // Handle logout failure, e.g., by displaying an error message
                        console.error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error during server logout:', error);
                });
        }

        //-------------- Execution Logic ------------------//
        //if products table is empty, fill the table with the data from the DB
        if (fetched_products == false) {
            populateProductsTable();
        }

        //lastly, initialize event listeners
        initializeTabEventListeners();
        initializeButtonEventListeners();

    </script>
</body>

</html>